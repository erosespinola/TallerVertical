<!DOCTYTPE HTML>
<html>
	<head>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<style type="text/css">
			body {
			  font: 12px sans-serif;
			  margin: 0;
			}
			path.line {
			  fill: none;
			  stroke: #666;
			  stroke-width: 1.5px;
			}

			path.area {
			  fill: #e7e7e7;
			}

			.axis {
			  shape-rendering: crispEdges;
			}

			.x.axis line {
			  stroke: #fff;
			}

			.x.axis .minor {
			  stroke-opacity: .5;
			}

			.x.axis path {
			  display: none;
			}

			.x.axis line, .x.axis path, .y.axis line, .y.axis path {
			  fill: none;
			  stroke: none;
			}
		</style>
	</head>
	<body>
		<div id="visualization">
			<img src="./Taller%20Vertical/assets/background_full.svg">
		</div>

		<script type="text/javascript">
		//Data
		var canvas_width = 940;
		var canvas_height = 480;
		var names = new Array();
		var finalTarget = new Array();
		var goalStatus = new Array();
		var max = 0;
		var teamPerformance = new Array();
		var margin;
		var sX, sY;
		var xAxis, yAxis;
		var canvas;
		var scale = 1000;

		d3.json("team-performance.json", function (d){readJson(d);});

		function readJson(datos) {
			for (var  i= 0;i<datos.teamPerformance.length;i++){
				finalTarget[i] = (datos.teamPerformance[i].finalTarget)/scale;
				names[i] = datos.teamPerformance[i].name;
				goalStatus[i] = datos.teamPerformance[i].goalStatus;
				if (datos.teamPerformance[i].finalTarget > max) {
						max = datos.teamPerformance[i].finalTarget;
				}
				for (var j = 0;j<datos.teamPerformance[i].data.length;j++){
					//Type
						//console.log(datos.teamPerformance[i].data[j].type);
					//Date
						//console.log(datos.teamPerformance[i].data[j].date);
					//Amount
						//console.log(datos.teamPerformance[i].data[j].amount);
					if (datos.teamPerformance[i].data[j].amount > max) {
						max = datos.teamPerformance[i].data[j].amount;
					}
				}
			}
			max=(max/scale)+(Math.pow(10,(max.toString().length-4)));
			createAxis();
		}

		function createAxis(){
			//Scales
			sX = d3.scale.ordinal()
				.domain(names.slice(0,5))
				.rangeRoundBands([0,canvas_width],.5);

			sY = d3.scale.linear()
				.domain([0, max])
				.range([canvas_height,0]);
			
			//Axis
			xAxis = d3.svg.axis()
				.scale(sX)
				.orient("bottom");
			yAxis = d3.svg.axis()
				.scale(sY)
				//.ticks(5)
				.tickFormat(function(d){
					return ("$"+d+" K");
				})
				.orient("right");
			createViewPort();
		}

		function createViewPort(){
			canvas = d3.select("body").append("div")
				.attr("id","datos")
				.style("position","relative")
				.style("top",-480)
				.append("svg")
					.attr("width",canvas_width)
					.attr("height",canvas_height);

			canvas.append("g")
				.attr("class","x axis")
				.attr("transform","translate(30,"+(canvas_height-23)+")")
				.attr("position","realtive")
				.call(xAxis);
			
			canvas.append("g")
				.attr("class","y axis")
				.attr("transform", "translate(0,0)")
				.call(yAxis)
					.selectAll("text")
						.attr("dy", "-.5em");

		    graphicGrid();
		}

		function graphicGrid(){
			console.log(sY.ticks());
			canvas.append("svg").selectAll("line")
				.data(sY.ticks())
				.enter().append("line")
					.attr("x1",0)
					.attr("y1",function(d){
						return sY(d);
					})
					.attr("x2",canvas_width)
					.attr("y2",function(d){
						return sY(d);
					})
					.attr("stroke","black")
					.attr("stroke-width",0.5);
				drawMountains();
		}
		
		function drawMountains(){
			var ps = 0;
			var last_width = 0;
			var mountains = new Array();
			for(var i=0;i<finalTarget.length;i++){
				if(last_width<((canvas_height - sY(finalTarget[i]))*1.25)){
	                ps=ps+last_width/2;
	                last_width=((canvas_height - sY(finalTarget[i]))*1.25);
					if(ps>canvas_width)canvas_width=ps+last_width;
					mountains[i]=ps;
				}else{
	                ps=ps+last_width-((canvas_height - sY(finalTarget[i]))*1.25)/2;
	                last_width=((canvas_height - sY(finalTarget[i]))*1.25);
					if(ps>canvas_width)canvas_width=ps+last_width;
					mountains[i]=ps;
	            }
			}
			var finalTarget_reverse = finalTarget.reverse();
			var names_reverse = names.reverse();
			var x_text;
			canvas.selectAll("image").data(finalTarget_reverse)
				.enter()
				.append("image")
	    			.attr("xlink:href", "mountain.svg")
	    			.attr("x", function(d,i){return mountains[(finalTarget.length-1)-i];})
			        .attr("y", function(d){return sY(d);})
			        .attr("width", function(d){return (canvas_height - sY(d))*1.25;})
			        .attr("height", function(d){return canvas_height - sY(d);});
			for(var i=0; i<names.length; i++){
				x_text = mountains[(finalTarget.length-1)-i] + ((canvas_height - sY(finalTarget_reverse[i]))*1.25)/2;
				canvas.append("text")
					.attr("x", x_text)
                	.attr("y", canvas_height-10)
                	.attr("fill", "white")
					.text(names_reverse[i].split(" ")[0]);
			}
			d3.selectAll("body").selectAll("svg").attr("width",canvas_width);
  			sX.rangeRoundBands([0,canvas_width],1);
		}
		</script>
		<div id="slider">
			<script>
		</div>
	</body>
</html>